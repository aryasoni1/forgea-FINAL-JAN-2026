# Task A2 — Package Manager & Workspace

Date: 2026-02-05
Status: DRAFT

---

## Goal

Ensure pnpm workspace discovery is deterministic and policy-aligned by resolving workspace definition mismatches and documenting the authoritative workspace source for the monorepo.

---

## Scope (Binding)

### In Scope

- Resolve the workspace membership mismatch between `package.json.workspaces` and `pnpm-workspace.yaml`.
- Declare the authoritative workspace source for pnpm operations.
- Confirm `packageManager` pinning policy and enforcement approach.

### Out of Scope

- Any changes to application code or runtime behavior.
- CI pipeline changes beyond pnpm install enforcement.
- Schema or migration changes.
- Turborepo, ESLint, or TypeScript configuration changes unrelated to pnpm workspace discovery.

---

## Preconditions

- Docs Gatekeeper brief for A2 reviewed: /docs/docs-gatekeeper/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A2_Package Manager & Workspace.md
- Toolchain version authority consulted: /docs/toolchain-versions.md
- Official docs registry consulted: /docs/official-docs-registry.md
- Code Scout A2 findings reviewed: /docs/code-scout/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A2_Package Manager & Workspace.md

---

## Assumptions (Explicit)

- None. Any version or authority conflicts must be resolved before implementation.

---

## Locked Decisions (Derived from Documentation)

- `pnpm-workspace.yaml` defines the workspace root and membership globs. (Source: /docs/official-docs/EPIC-A/pnpm-workspaces.md)
- Internal workspace dependencies MUST use the `workspace:` protocol. (Source: /docs/official-docs/EPIC-A/pnpm-workspace-policy.md)
- pnpm version MUST be pinned per toolchain policy. (Source: /docs/toolchain-versions.md)

---

## Invariants (Must Not Be Violated)

- Workspace discovery remains deterministic for pnpm.
- No changes to application behavior or runtime.
- Lockfile semantics remain consistent across environments.

---

## Step-by-Step Plan (Non-Code)

1. Identify the authoritative workspace definition file and document it as the source of truth.
2. Align workspace membership globs across `pnpm-workspace.yaml` and `package.json.workspaces` based on that authority.
3. Validate pnpm version pinning policy against toolchain authority and resolve any version conflicts.
4. Specify verification steps to confirm workspace membership and pinned pnpm usage.

---

## Files Expected to Modify

- forgea-monorepo/pnpm-workspace.yaml
- forgea-monorepo/package.json (only if alignment requires changes here)
- docs/official-docs/EPIC-A/pnpm-workspace-policy.md (if policy updates are required)
- docs/official-docs/EPIC-A/pnpm-ci-guidelines.md (if enforcement guidance is required)

---

## Files to NOT Touch

- forgea-monorepo/apps/**
- forgea-monorepo/packages/** (excluding manifest updates, if required)
- forgea-monorepo/services/**
- forgea-monorepo/infra/**
- forgea-monorepo/packages/schema/prisma/migrations/** (LOCKED)

---

## Verification Criteria (Machine-Checkable)

- `pnpm-workspace.yaml` contains the authoritative workspace globs.
- `package.json.workspaces` is aligned with the authoritative workspace list.
- pnpm `packageManager` pin is consistent with toolchain policy and documented.

---

## Risks & Tradeoffs

- Version drift risk if pnpm pin in repo differs from toolchain policy.
- Mismatched workspace definitions can cause inconsistent installs across environments.

---

## Open Questions (Must Be Resolved)

1. Which exact pnpm pin is authoritative if toolchain policy and repository value diverge?
2. Should Corepack enforcement be required in CI for pnpm pinning, and if so, where is the policy documented?

---

## Dependencies

- Blocked by: Resolution of pnpm version authority conflicts and confirmation of workspace source-of-truth policy.
- Unlocks: Deterministic workspace installs and consistent pnpm behavior across environments.

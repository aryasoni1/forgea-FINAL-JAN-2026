---
doc_id: terraform-cli-workflow
tool: Terraform
version_pinned: true
change_sensitivity: HIGH
lifecycle: ACTIVE
---

# Terraform — CLI & Workflow Policy

## Purpose

Governs the standard lifecycle for infrastructure provisioning, mandating reproducible initialization stages, strict plan-apply separation for CI/CD pipelines, and consistent plugin management using the Terraform CLI.

## Status

- Doc type: INTERNAL / AUTHORITATIVE
- Evidence basis: Official vendor documentation only
- Version status: PINNED (v1.x)

## Scope

- Applies to: All usage of the `terraform` binary, including local development and automated pipelines (CI/CD).
- Does NOT apply to: Terraform Cloud/Enterprise UI-driven workflows (unless via CLI integration).

## Official Sources (Binding)

- "Terraform Init Command Reference Guide"
- "Terraform Plan Command Reference Guide"
- "Terraform Apply Command Reference"
- "Configuring the Terraform CLI Global Settings"
- "Mastering the Terraform CLI Environment Variables"

## Evidence Coverage Matrix

| Policy Area              | Source Reference                                  | Version Covered | Status  |
| ------------------------ | ------------------------------------------------- | --------------- | ------- |
| Initialization (`init`)  | Terraform Init Command Reference                  | v1.x            | COVERED |
| Plan Generation (`plan`) | Terraform Plan Command Reference                  | v1.x            | COVERED |
| Execution (`apply`)      | Terraform Apply Command Reference                 | v1.x            | COVERED |
| Automation Behavior      | Mastering the Terraform CLI Environment Variables | v1.x            | COVERED |
| Plugin Caching           | Configuring the Terraform CLI Global Settings     | v1.x            | COVERED |

## Version & Compatibility

- **Tool version:** Terraform v1.x (Context implies v1.0+ compatibility promises).
- **Lockfile:** `.terraform.lock.hcl` generation is mandatory for version consistency.

## Canonical Rules (Non-Negotiable)

- **Initialization Mandate:**
  - The working directory MUST be initialized using `terraform init` before any other commands (plan, apply) are executed,.
  - This command is idempotent and safe to run multiple times to update the working directory.
- **Dependency Locking:**
  - The dependency lock file (`.terraform.lock.hcl`) generated by `terraform init` MUST be committed to version control.
  - CI/CD pipelines must rely on this lock file to ensure the exact same provider versions are used as during development.
- **Plan-Apply Separation (Automation):**
  - For automation/CI, `terraform plan` MUST use the `-out=FILE` option to save the execution plan to a file.
  - `terraform apply` MUST be executed against this specific saved plan file (e.g., `terraform apply tfplan`) to ensure strictly reproducible execution without prompts,.
- **Input Suppression:**
  - In non-interactive environments (CI), all commands MUST use `-input=false` (or set `TF_INPUT=0`) to prevent the process from hanging on variable prompts,,.
- **Plugin Caching:**
  - To optimize bandwidth and build times, a persistent plugin cache SHOULD be configured via `plugin_cache_dir` in the CLI config or `TF_PLUGIN_CACHE_DIR` env var,.
  - The cache directory MUST exist before Terraform runs; Terraform will not create it.
- **Automation Signal:**
  - CI environments MUST set the environment variable `TF_IN_AUTOMATION` to a non-empty value to adjust output for log readability (suppressing "next step" suggestions).

## Prohibited Configurations

- ❌ **Implicit Apply:** Running `terraform apply` without a saved plan file in production CI pipelines is PROHIBITED.
- ❌ **Committing `.terraform`:** The `.terraform` directory (containing plugins and backend config) MUST NOT be committed to version control,.
- ❌ **Concurrent Cache Access:** Multiple concurrent `terraform init` processes MUST NOT write to the same plugin cache directory simultaneously, as it is not concurrency safe.
- ❌ **Breaking Lockfiles:** The setting `plugin_cache_may_break_dependency_lock_file` MUST NOT be enabled unless strictly required for exceptional transitional states,.

## Enforcement

- **CLI Execution:**
  - `terraform init` fails if backend configuration or plugin requirements cannot be satisfied.
  - `terraform plan` with `-detailed-exitcode` returns:
    - `0`: Succeeded, no diffs.
    - `1`: Error.
    - `2`: Succeeded, non-empty diff (changes present).
- **State Locking:**
  - By default, operations acquire a state lock. If the lock is held by another process, the command fails immediately unless `-lock-timeout` is specified.

## Failure Modes

- **Lock Contention:** If a previous run crashed or is still running, `terraform plan/apply` will fail with a lock error.
- **Prompt Hanging:** If `-input=false` is omitted and a variable is missing, the CI process will hang indefinitely waiting for user input.
- **Drift:** If `terraform apply` is run without a saved plan, the infrastructure state may change between the plan visualization and the execution, leading to unpredictable results.

## Cross-Doc Dependencies

- Depends on:
  - `/docs/official-docs/nextjs-environment-variables.md` (If Terraform manages Next.js env vars).
- Conflicts with:
  - NONE

## Planner Extraction Hints (Non-Human)

- If `env.CI` == "true", `TF_IN_AUTOMATION` MUST be "true".
- If `env.CI` == "true", `terraform plan` MUST include `-out`.
- If `env.CI` == "true", `terraform apply` MUST NOT include `-auto-approve` (use saved plan instead).
- `terraform init` MUST precede `plan` or `apply`.

## Verification Checklist

- [ ] `.terraform.lock.hcl` is tracked in git.
- [ ] `.terraform` directory is ignored in `.gitignore`.
- [ ] CI pipeline executes `init`, then `plan -out=tfplan`, then `apply tfplan`.
- [ ] `TF_IN_AUTOMATION` is set in the pipeline environment.

## Non-Decisions

- This document does not define the specific backend (S3, Consul, Remote) to be used, only that it must be initialized.
- This document does not mandate a specific directory structure for modules.

## Notes

- `terraform validate` runs syntax checks without accessing remote services or state.
- `terraform fmt` is recommended for style consistency but is not a functional requirement for provisioning.

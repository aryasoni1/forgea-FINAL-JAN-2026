# Task A11 — Verification & Quality Gates

Date: 2026-02-06
Status: APPROVED

---

## Goal

Design the verification/quality gate layer that the repo currently lacks by wiring Turborepo `verify`/`lint` flows into a tracked CI workflow and extending the canonical docs so every implementer knows which versions of Turborepo, ESLint, and Prettier to run, how the caches behave, and what counts as a blocking check.

---

## Docs Gatekeeper Findings (Advisory)

Source: /docs/docs-gatekeeper/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A11_Verification & Quality Gates.md

- Turborepo documentation must pin the `turbo` version (currently UNKNOWN in the doc), enumerate caching guarantees, and capture the schema/pipeline semantics so verification gates are deterministic across CI runs.
- ESLint boundary guidance needs a pinned `eslint` and plugin version plus CI invocation and failure semantics.
- Prettier guidance must pin the formatting tool and describe CI check-only behavior rather than ad-hoc formatting.
- All of these pinned references are blocking inputs for planning and are currently flagged as VERSION UNKNOWN; they must be resolved before implementation.

---

## Documentation Registry Alignment

Source: /docs/official-docs-registry.md

- Turborepo is listed with major 2.x and primary pin 2.1.x but the internal doc still lacks an explicit semver statement; we must align the doc text with the registry requirements.
- ESLint, eslint-plugin-boundaries, and Prettier are already audited elsewhere in the registry but the gatekeeper wants us to extend `/docs/official-docs/EPIC-A/eslint-boundaries.md` and `/docs/official-docs/EPIC-A/prettier.md` with versioned CI guidance.
- No additional registry entries are required beyond confirming these docs now cover the pinned tooling references.

---

## Toolchain Version Authority

Source: /docs/toolchain-versions.md

- Turborepo must stay in the `2.1.x` series (`>=2.0.0 <3.0.0` per policy); any deviation requires a policy review and must be documented in the Turborepo guide.
- ESLint is enforced as a Flat Config 9.x artifact and Prettier as 3.x, with both requiring explicit pins when used in CI.
- Node.js 20.x is the supported runtime for running Turborepo/ESLint/Prettier in CI, so the workflow must target that environment.

---

## Code Scout Facts (Constraints)

Source: /docs/code-scout/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A11_Verification & Quality Gates.md

- `forgea-monorepo/package.json` already orchestrates `build` and `lint` via `turbo run`, but there is no committed CI workflow under `.github/workflows` (nor any CircleCI/GitLab/Azure config) to execute these commands in automation.
- Verification features live inside `apps/forgea-labs` and the repo contains verification DB model artifacts, yet no automated CI gate exists to run `verify-and-lint` traces or output `VerificationLog` entries as part of quality gates.
- Turborepo traces such as `verify-and-lint` and `verify-typescript-setup` indicate expected CI tasks, but no pipeline is defined to enforce these quality checks.
- There is no documentation describing expected verification gates or required environment variables for CI.

---

## Scope (Binding)

### In Scope

- Authoring `.github/workflows` YAML (or another repository-controlled CI definition) that runs the canonical Turborepo verification and lint scripts `turbo run verify-and-lint` / `turbo run build` and reports failures as blocking checks.
- Extending `/docs/official-docs/EPIC-A/turborepo.md`, `/docs/official-docs/EPIC-A/eslint-boundaries.md`, and `/docs/official-docs/EPIC-A/prettier.md` with the pinned versions, CI knobs, and caching semantics required by the Docs Gatekeeper for Feature A11.
- Recording the required doc updates in `/docs/master_docs.md` and adding the mandated test plan at `/docs/tests/task-A11-tests.md` so that future agents know where to look for acceptance criteria.
- Defining the CI job runner requirements (Node 20.x base image, `turbo` 2.1.x, ESLint/Prettier versions) and describing the desired verification gate (e.g., failure if lint/verification/build fail, outputs to `VerificationLog`).

### Out of Scope

- Implementing the actual verification UI/backend logic in `apps/forgea-labs` or database migrations; those are already present and outside this doc/task.
- Setting up external CI infrastructure outside the repository (e.g., org-level GitHub Actions). The workflow must live inside `.github/workflows` or another repo folder we control.
- Changing runtime behavior of verification flows beyond what the documented jobs specify; we only define the gating automation and docs.

---

## Locked Decisions (Derived from Documentation)

1. Turborepo configuration must conform to the documented schema semantics (`turbo.json`, `dependsOn`, `outputs`, `env`), and caching is considered local-only today until a provider is approved. (Source: /docs/official-docs/EPIC-A/turborepo.md)
2. pnpm workspace discovery and TypeScript project references remain authoritative via their respective docs; CI jobs must respect the existing workspace layout. (Sources: /docs/official-docs/EPIC-A/pnpm-workspaces.md, /docs/official-docs/EPIC-A/typescript-project-references.md)
3. ESLint Flat Config with `eslint-plugin-boundaries` must be enforced with the pinned versions (ESLint 9.39.x, boundaries 4.2.x); lint failures must fail the workflow. (Sources: /docs/official-docs/EPIC-A/eslint-boundaries.md, /docs/toolchain-versions.md)
4. Prettier formatting checks in CI must run in `--check` mode with version 3.2.x and fail the pipeline instead of rewriting files. (Sources: /docs/official-docs/EPIC-A/prettier.md, /docs/toolchain-versions.md)
5. Node.js 20.x is the only supported runtime for CI steps running Turborepo/ESLint/Prettier. (Sources: /docs/official-docs-registry.md & /docs/toolchain-versions.md)

## Locked Decisions (Resolved)

- Turborepo is pinned to 2.1.x (`^2.1.0`) for all CI verification workflows. Any upgrade outside this range requires policy review.
- ESLint is enforced at 9.39.x using Flat Config with eslint-plugin-boundaries 4.2.x, and lint failures must fail the workflow.
- Prettier is enforced at 3.2.x in check-only mode in CI; formatting violations fail without rewriting files.
- CI uses Turborepo local caching only; no remote cache provider is assumed.
- Verification workflows live under `.github/workflows/verification-and-quality-gates.yml` and block PRs plus pushes to protected branches when they fail.

---

## Resolved Decisions (User-Provided)

- Turborepo is pinned to 2.1.x (`^2.1.0`) for all CI verification workflows; upgrades outside that range require policy review. (Sources: /docs/toolchain-versions.md, /docs/official-docs-registry.md)
- ESLint must run at 9.39.x using Flat Config plus eslint-plugin-boundaries 4.2.x; lint failures must fail the workflow. (Source: /docs/toolchain-versions.md)
- Prettier must run at 3.2.x in check-only mode during CI; formatting violations must fail without rewriting files. (Source: /docs/toolchain-versions.md)
- The workflow uses Turborepo local caching only; remote cache providers are optional and must be approved/documented prior to reliance. (Sources: gatekeeper advisory, A10 resolution)
- Verification gates live under `.github/workflows/verification-and-quality-gates.yml` and block PRs/pushes to protected branches when they fail. (Source: repo findings + user decision)

---

## Invariants (Must Not Be Violated)

- Every verification gate in CI must execute the same `turbo run` scripts that exist locally to keep CI parity.
- Documentation of tooling versions/caching must remain synchronized with `/docs/official-docs-registry.md` and `/docs/toolchain-versions.md` to avoid undermining the Docs Gatekeeper.
- Workflows should not depend on external secrets or providers until those services are explicitly approved and documented.

---

## Open Questions (Must Be Resolved)

- None; all architecture decisions have been resolved with the latest inputs.

---

## Step-by-Step Plan (Non-Code)

1. Update the documentation we plan to extend so they explicitly cite the resolved pins (Turbo 2.1.x, ESLint 9.39.x with boundaries 4.2.x, Prettier 3.2.x) and the local-only cache posture, ensuring Gatekeeper requirements are met before implementation.
2. Define the CI workflow (under `.github/workflows/verification-and-quality-gates.yml`) that executes `turbo run verify-and-lint`, `turbo run build`, and any other necessary verification tasks on Node 20.x runners, fails when commands exit non-zero, and optionally logs artifacts or `VerificationLog` indicators.
3. Update `/docs/official-docs/EPIC-A/turborepo.md` with a `Version & Compatibility` section that names the pinned `turbo` release, the schema URL, cache expectations (local-only unless approved), and `npm`/`pnpm` restrictions for CI jobs.
4. Extend `/docs/official-docs/EPIC-A/eslint-boundaries.md` with the CI invocation strategy, the pinned ESLint/boundaries versions, and clarifications on failure semantics to ensure workflows fail on lint regressions.
5. Extend `/docs/official-docs/EPIC-A/prettier.md` to document the exact Prettier version, the check-only invocation, and how formatting issues should be surfaced in CI.
6. Document the new workflow and its gating rules in `/docs/master_docs.md` so the overall docs registry knows Feature A11 introduces the verification pipelines and locked docs, and add the required test plan entry at `/docs/tests/task-A11-tests.md` describing how to verify the workflow locally.
7. Validate that the new CI workflow references the documented tools (matching the pinned versions) and that the docs reference the workflow path and gating semantics, satisfying the code-scout acceptance criteria.

---

## Files Expected to Modify

- forgea-monorepo/.github/workflows/verification-and-quality-gates.yml (or the agreed workflow path)
- /docs/official-docs/EPIC-A/turborepo.md
- /docs/official-docs/EPIC-A/eslint-boundaries.md
- /docs/official-docs/EPIC-A/prettier.md
- /docs/master_docs.md (recording the new doc coverage and workflow requirement)
- /docs/tests/task-A11-tests.md (new test plan describing verification of the gates)

---

## Files to NOT Touch

- apps/**, packages/**, services/\*\* source code (verification logic already present)
- Existing CI/infra outside `.github/workflows` (nothing exists yet)
- forgea-monorepo/infra/\*\*

---

## Verification Criteria (Machine-Checkable)

- A workflow file exists under the repository (e.g., `.github/workflows/verification-and-quality-gates.yml`) that runs the designated Turborepo tasks and fails when verify/lint/build commands do.
- `/docs/official-docs/EPIC-A/turborepo.md`, `/docs/official-docs/EPIC-A/eslint-boundaries.md`, and `/docs/official-docs/EPIC-A/prettier.md` all explicitly list the pinned versions and CI run instructions required by the gatekeeper.
- `/docs/master_docs.md` references the Feature A11 doc entries and the new workflow so the master registry knows the requirements are satisfied.
- `/docs/tests/task-A11-tests.md` describes how to exercise the new workflow locally (e.g., using `pnpm turbo run` or `./.github/workflows/` definitions) and checks for gating semantics.
- The documentation and workflow remain consistent with `/docs/official-docs-registry.md` (no mismatched version references).

---

## Acceptance Criteria Blockers

- None; all tooling, caching, and workflow decisions have been resolved per the latest guidance.

---

## Risks & Tradeoffs

- Locking CI to specific versions prevents unvetted upgrades but requires manual updates when newer versions become available.
- Adding workflow files without the right version info creates misleading documentation and might break gating; hence the open questions must be resolved first.
- Documenting remote caches before a provider exists risks implying infrastructure promises; we mitigate this by stating the default is local-only until approved.

---

- Blocked by: None; all decision blockers are cleared.
- Unlocks: Verified CI enforcement for build/lint/verify and updated docs that let downstream agents implement the gating with confidence.

---

## Testing

- Test plan will live in `/docs/tests/task-A11-tests.md` and describe how to simulate the workflow locally (via `pnpm turbo run verify-and-lint`, etc.) and confirm failure modes.
- The implementer must not execute tests during planning; the test plan only needs to document the expected verification steps.

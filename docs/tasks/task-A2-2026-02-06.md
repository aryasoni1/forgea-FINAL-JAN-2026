# Task A2 — Package Manager & Workspace

Date: 2026-02-06
Status: APPROVED

---

## Goal

Ensure pnpm workspace discovery is deterministic and policy-aligned by resolving workspace definition mismatches and documenting the authoritative workspace source for the monorepo.

---

## Docs Gatekeeper Findings (Advisory)

Source: /docs/docs-gatekeeper/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A2_Package Manager & Workspace.md

- Required official documentation: pnpm workspaces (pnpm v10.28.1 in gatekeeper brief).
- Required internal docs listed: /docs/official-docs/pnpm-workspace-policy.md and /docs/official-docs/pnpm-ci-guidelines.md.
- Master docs registry updates required in /docs/master_docs.md.
- Conflict risk: gatekeeper brief references pnpm v10.28.1, while toolchain and registry list pnpm 10.4.x.

Planner note: This conflict must be surfaced and resolved before implementation decisions that change version pins.

---

## Documentation Registry Alignment

Source: /docs/official-docs-registry.md

- pnpm is VERIFIED with primary pin 10.4.x and internal docs:
  - /docs/official-docs/EPIC-A/pnpm-workspaces.md
  - /docs/official-docs/EPIC-A/pnpm-workspace-policy.md
  - /docs/official-docs/EPIC-A/pnpm-ci-guidelines.md

---

## Toolchain Version Authority

Source: /docs/toolchain-versions.md

- pnpm primary pin: 10.4.x (packageManager example uses pnpm@10.4.0)
- Toolchain document is the single source of truth for tool versions.

---

## Code Scout Facts (Constraints)

Source: /docs/code-scout/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A2_Package Manager & Workspace.md

- forgea-monorepo/package.json:
  - packageManager: pnpm@10.28.1
  - workspaces: ["apps/*","packages/*","services/*"]
- forgea-monorepo/pnpm-workspace.yaml:
  - packages: apps/_, packages/_
  - services/\* is missing

---

## Scope (Binding)

### In Scope

- Resolve the workspace membership mismatch between package.json.workspaces and pnpm-workspace.yaml.
- Declare the authoritative workspace source for pnpm operations.
- Confirm packageManager pinning policy and enforcement approach (documentation-level, not CI changes).
- Update master documentation registry entries per Docs Gatekeeper.

### Out of Scope

- Any changes to application code or runtime behavior.
- CI pipeline changes beyond pnpm install enforcement documentation.
- Schema or migration changes.
- Turborepo, ESLint, or TypeScript configuration changes unrelated to pnpm workspace discovery.

---

## Locked Decisions (Derived from Documentation)

1. `pnpm-workspace.yaml` defines the workspace root and membership globs.
   Source: /docs/official-docs/EPIC-A/pnpm-workspace-policy.md

2. Internal workspace dependencies MUST use the `workspace:` protocol.
   Source: /docs/official-docs/EPIC-A/pnpm-workspace-policy.md

3. Toolchain versions are authoritative for tool version pins.
   Source: /docs/toolchain-versions.md

---

## Open Questions (Must Be Resolved)

1. pnpm version conflict: toolchain/registry specify 10.4.x, but repository packageManager is pnpm@10.28.1. Which version should be applied and reconciled across docs and repo?
   Sources in conflict: /docs/toolchain-versions.md, /docs/official-docs-registry.md, /forgea-monorepo/package.json

2. Corepack enforcement: official docs note Corepack support, but do not mandate it. Should policy require Corepack usage in developer machines and CI, or remain advisory?
   Source: /docs/official-docs/EPIC-A/pnpm-ci-guidelines.md

---

## Invariants (Must Not Be Violated)

- Workspace discovery remains deterministic for pnpm.
- No changes to application behavior or runtime.
- Lockfile semantics remain consistent across environments.

---

## Step-by-Step Plan (Non-Code)

1. Declare the authoritative workspace definition file in policy docs, aligned with the official doc rule that pnpm-workspace.yaml is the source of truth.
2. Decide how to reconcile the workspace mismatch (add services/_ to pnpm-workspace.yaml or remove services/_ from package.json.workspaces) while keeping pnpm-workspace.yaml authoritative.
3. Resolve the pnpm version conflict using toolchain-versions as authority, then align packageManager and documentation accordingly.
4. Update official docs to document CI/developer guidance for pnpm usage (including any Corepack requirement, if approved) without changing CI pipelines in this task.
5. Append required entries to /docs/master_docs.md per Docs Gatekeeper instructions.
6. Define verification checks to confirm workspace membership alignment and packageManager pin consistency.

---

## Files Expected to Modify

- forgea-monorepo/pnpm-workspace.yaml
- forgea-monorepo/package.json (only if alignment requires changes here)
- docs/official-docs/EPIC-A/pnpm-workspace-policy.md
- docs/official-docs/EPIC-A/pnpm-ci-guidelines.md
- docs/master_docs.md

---

## Files to NOT Touch

- forgea-monorepo/apps/\*\*
- forgea-monorepo/packages/\*\* (excluding manifest updates, if required)
- forgea-monorepo/services/\*\*
- forgea-monorepo/infra/\*\*
- forgea-monorepo/packages/schema/prisma/migrations/\*\* (LOCKED)

---

## Verification Criteria (Machine-Checkable)

- pnpm-workspace.yaml contains the authoritative workspace globs.
- package.json.workspaces is aligned with pnpm-workspace.yaml or explicitly documented as non-authoritative.
- packageManager pin matches toolchain-versions policy.
- master_docs.md contains the required entries listed in the Docs Gatekeeper brief.

---

## Risks & Tradeoffs

- Version drift risk if pnpm pin in repo differs from toolchain policy.
- Mismatched workspace definitions can cause inconsistent installs across environments.
- Policy-level Corepack requirement without CI wiring could lead to partial adoption.

---

## Dependencies

- Blocked by: Resolution of pnpm version authority conflict and Corepack policy decision.
- Unlocks: Deterministic workspace installs and consistent pnpm behavior across environments.

# Task B2 — Prisma Setup & Migrations

Date: 2026-02-09
Status: APPROVED

---

## Goal

Define the authoritative Prisma initialization, datasource configuration, client generation, and migration workflows for the repo, aligned with official Prisma 7.3.0 documentation and existing schema/migrations layout.

---

## Docs Gatekeeper Findings (Advisory)

Source: /docs/docs-gatekeeper/EPIC-B — DATABASE CORE & HARDENING/B2_Prisma Setup & Migrations.md

- Required official documentation categories (Prisma 7.3.0): CLI/project init, schema datasource conventions, client generation, migrate dev workflow.
- Internal docs exist but were flagged as insufficient in the Gatekeeper brief and require extension.
- Required follow-up: add or extend internal Prisma docs and append to master_docs.md.

Planner note: Gatekeeper reported required docs are Prisma 7.3.0 and that internal docs must be updated; this plan treats those as binding inputs.

---

## Documentation Registry Alignment

Source: /docs/official-docs-registry.md

- Prisma is VERIFIED with version 7.3.0 and internal docs:
  - /docs/official-docs/EPIC-B/prisma_official.md
  - /docs/official-docs/EPIC-B/prisma_migrations.md

---

## Toolchain Version Authority

Source: /docs/toolchain-versions.md

- Prisma is listed with exact pin 7.3.0.
- Allowed range: `>=7.3.0 <8.0.0`.

---

## Code Scout Facts (Constraints)

Source: /docs/code-scout/EPIC-B — DATABASE CORE & HARDENING/B2_Prisma Setup & Migrations.md

- Prisma schema exists at /forgea-monorepo/packages/schema/prisma/schema.prisma with provider set to postgresql.
- `datasource.url` is not declared in schema; prisma.config.mjs provides `datasource.url` via env("DATABASE_URL").
- Migrations exist under /forgea-monorepo/packages/schema/prisma/migrations with migration_lock.toml.
- Seed script exists at /forgea-monorepo/packages/schema/prisma/seed.ts.
- `prisma:generate` script exists in /forgea-monorepo/packages/schema/package.json.
- DATABASE_URL examples exist in /forgea-monorepo/.env and /forgea-monorepo/apps/forgea-labs/.env.local.

---

## Scope (Binding)

### In Scope

- Decide and document the canonical datasource configuration pattern (schema.prisma inline env() vs prisma.config.mjs).
- Align internal Prisma docs with official 7.3.0 references and repo realities.
- Define development vs production migration workflows using Prisma commands.
- Update master docs registry entries as required by Docs Gatekeeper.

### Out of Scope

- Database provisioning (Docker/Terraform), infra changes, or DB instance creation.
- Editing or rewriting existing migration SQL files.
- Application feature changes outside the Prisma schema/migrations policy.
- Any runtime code refactors unrelated to Prisma configuration.

---

## Locked Decisions (Derived from Documentation)

1. Development workflow MUST use `prisma migrate dev`; production/staging MUST use `prisma migrate deploy`.
   Source: /docs/official-docs/EPIC-B/prisma_migrations.md

2. The Prisma schema MUST define exactly one datasource block, and connection URLs MUST be sourced via env() or prisma.config.ts (no hardcoded secrets).
   Source: /docs/official-docs/EPIC-B/prisma_official.md

3. Prisma configuration follows a hybrid approach: `schema.prisma` defines the datasource using `url = env("DATABASE_URL")`, while `prisma.config.ts` provides runtime config/seed/migration settings and MUST NOT conflict with the schema datasource.
   Source: User decision (2026-02-09)

4. The `generator client` output path MUST be explicit and set to `../../node_modules/@prisma/client`.
   Source: User decision (2026-02-09)

5. Migration history in prisma/migrations is the authoritative schema evolution record; applied migrations MUST NOT be edited.
   Source: /docs/official-docs/EPIC-B/prisma_migrations.md

6. `migration_lock.toml` is write-only: MUST NOT be edited, deleted, or regenerated outside Prisma.
   Source: User decision (2026-02-09)

7. Prisma MUST be listed in /docs/toolchain-versions.md with major 7.x, exact pin 7.3.0, and allowed range `>=7.3.0 <8.0.0`.
   Source: User decision (2026-02-09) + Toolchain policy

---

---

## Invariants (Must Not Be Violated)

- Prisma migrations remain deterministic and auditable.
- No secrets are hardcoded into schema.prisma or committed config files.
- Production workflows never use `migrate dev`.

---

## Step-by-Step Plan (Non-Code)

1. Update /docs/official-docs/EPIC-B/prisma_official.md with version-pinned official links and the hybrid configuration pattern (schema datasource + prisma.config.ts for runtime/seed).
2. Update /docs/official-docs/EPIC-B/prisma_migrations.md with version-pinned official links and a clear migration lifecycle (dev vs deploy), including the shadow DB requirement and `migration_lock.toml` policy.
3. If the datasource pattern decision requires repo changes, define the minimal set of file edits (schema.prisma and/or prisma.config.ts) required for alignment.
4. Append the required entry to /docs/master_docs.md per the Docs Gatekeeper brief.
5. Define verification checks (schema has single datasource, generator output path set, migrations folder intact, CI uses migrate deploy).

---

## Files Expected to Modify

- docs/toolchain-versions.md (if Prisma is added as a governed tool)
- docs/official-docs/EPIC-B/prisma_official.md
- docs/official-docs/EPIC-B/prisma_migrations.md
- docs/master_docs.md
- forgea-monorepo/packages/schema/prisma/schema.prisma (only if datasource pattern decision requires it)
- forgea-monorepo/packages/schema/prisma.config.ts (only if datasource pattern decision requires it)

---

## Files to NOT Touch

- forgea-monorepo/packages/schema/prisma/migrations/\*\* (LOCKED)
- forgea-monorepo/apps/\*\* (unrelated to Prisma configuration)
- forgea-monorepo/services/\*\* (unless a direct Prisma config dependency is confirmed)

---

## Verification Criteria (Machine-Checkable)

- Prisma is listed in toolchain-versions or an exception is recorded.
- Internal Prisma docs include version-pinned official links for init, schema configuration, client generation, and migrate dev workflow.
- datasource configuration pattern is documented and consistent with code.
- `generator client` output path is `../../node_modules/@prisma/client`.
- Migration policy states `migrate dev` for dev and `migrate deploy` for prod.
- master_docs.md includes the required entry for this gatekeeper brief.

---

## Risks & Tradeoffs

- Toolchain exclusion of Prisma blocks policy-aligned implementation until resolved.
- Divergent datasource configuration patterns can cause onboarding errors and inconsistent migration behaviors.
- Changing datasource configuration may require careful coordination with local env handling.

---

## Dependencies

- Blocked by: None.
- Unlocks: Consistent Prisma onboarding, deterministic migrations, and aligned client generation.

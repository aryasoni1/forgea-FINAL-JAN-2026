# Task B3 — Identity & Authentication Tables

Date: 2026-02-09
Status: APPROVED

---

## Goal

Bring the identity and authentication schema into compliance with EPIC-B tasks 11–22 by reconciling existing Prisma auth models with required names/enums, adding missing fields and constraints, and defining a safe migration path that preserves data and ensures deterministic auth behavior.

---

## Scope (Binding)

### In Scope

- Align `User` model with required fields and constraints (timestamps, role enum values).
- Define `authProvider` enum values (EMAIL, GOOGLE, GITHUB) and apply to auth identity storage.
- Reconcile required model names (`AuthSession`, `AuthIdentity`) with existing `Session`/`Account` models.
- Ensure uniqueness constraints for provider + providerUserId and user email are enforced.
- Plan migration steps in Prisma (new migration only) without editing applied migrations.

### Out of Scope

- Application-level auth flow changes (NextAuth config, session handling, UI changes).
- Any changes to GitHub App auth policies or API usage.
- Non-auth database tables or unrelated migrations.

---

## Preconditions

- Docs Gatekeeper inputs for B3 reviewed.
- Official docs registry consulted: /docs/official-docs-registry.md.
- Toolchain versions sourced from /docs/toolchain-versions.md.
- Code Scout findings for B3 incorporated.

---

## Assumptions (Explicit)

- Prisma version 7.3.0 is authoritative for schema and migration behavior.
- PostgreSQL version 18.1 is authoritative for database constraint behavior.

---

## Locked Decisions (Derived from Documentation)

- Prisma schema changes MUST be represented via a new migration; applied migrations MUST NOT be edited. (Source: /docs/official-docs/EPIC-B/prisma_migrations.md)
- Development schema changes MUST use `prisma migrate dev`; production/staging deployment MUST use `prisma migrate deploy`. (Source: /docs/official-docs/EPIC-B/prisma_migrations.md)
- Every model MUST have a primary key or unique constraint. (Source: /docs/official-docs/EPIC-B/prisma_official.md)
- If table names differ from model names, `@@map` MUST be used to preserve database naming. (Source: /docs/official-docs/EPIC-B/prisma_official.md)

---

## Resolved Decisions (User-Provided)

- UserRole enum must replace legacy `CANDIDATE` with `USER`, resulting in `ADMIN`, `USER`, `RECRUITER`.
- Auth model migration strategy is additive: create new `AuthSession` and `AuthIdentity` tables while preserving existing `Session` and `Account` data for rollback and verification.
- Migrations involving uniqueness constraint changes or table renames must be performed in a maintenance window to prevent concurrent write failures.

---

## Current State Summary (From Code Scout)

- `User` model exists with `id`, `email`, `role`, `githubId`, `icprScore` and relations to `Account` and `Session`.
- `email` is unique.
- `UserRole` enum exists with values `CANDIDATE`, `ADMIN`, `RECRUITER`.
- `Session` and `Account` models exist with foreign keys to `User` and provider uniqueness on `Account`.
- `User` lacks explicit timestamps.
- No `authProvider` enum. No `AuthSession`/`AuthIdentity` models by name.

---

## Step-by-Step Plan (Non-Code)

1. **Auth model strategy**: implement an additive migration with new `AuthSession` and `AuthIdentity` tables while preserving existing `Session`/`Account` data for rollback and verification.
2. **UserRole enum alignment**: rename `CANDIDATE` to `USER` and align enum values to `ADMIN`, `USER`, `RECRUITER`, with a safe data backfill plan.
3. **Add missing `User` timestamps**: define `createdAt`/`updatedAt` fields and determine default and update behavior consistent with Prisma capabilities and existing data.
4. **Introduce `authProvider` enum**: define values EMAIL, GOOGLE, GITHUB and apply to auth identity storage (replacing string provider where appropriate).
5. **Define auth identity uniqueness**: ensure provider + providerUserId uniqueness is enforced on the chosen auth identity model.
6. **Define session expiry semantics**: ensure `AuthSession` (or mapped `Session`) includes expiry and aligns with existing `expires` usage.
7. **Plan migration strategy**: prepare a new Prisma migration that introduces required schema changes without editing existing migrations, including any data backfill steps if enum values or tables are changed.
8. **Define verification checks**: confirm schema and constraints via Prisma validate + migration review, and confirm uniqueness constraints and enums exist as specified.

---

## Files Expected to Modify

- forgea-monorepo/packages/schema/prisma/schema.prisma
- forgea-monorepo/packages/schema/prisma/migrations/\*\* (new migration only)

---

## Files to NOT Touch

- forgea-monorepo/apps/\*\*
- forgea-monorepo/services/\*\*
- forgea-monorepo/infra/\*\*
- forgea-monorepo/packages/\*\* (other than schema package)

---

## Verification Criteria (Machine-Checkable)

- `User` has `createdAt` and `updatedAt` fields.
- `UserRole` enum values match approved decision (ADMIN, USER, RECRUITER) with no ambiguity.
- `authProvider` enum exists with values EMAIL, GOOGLE, GITHUB.
- Auth identity model enforces unique constraint on (provider, providerUserId).
- Auth session model includes expiry field aligned to required semantics.
- All schema changes are represented in a new migration without modifying existing migrations.

---

## Risks & Tradeoffs

- Renaming or re-mapping auth models risks breaking existing code that references `Session`/`Account` by name.
- Introducing new tables requires data migration and possible downtime or backfill complexity.
- Changing enum values (CANDIDATE → USER) can invalidate existing rows unless a safe backfill is defined.

---

## Open Questions (Must Be Resolved)

- None.

---

## Dependencies

- Blocked by: None.
- Unlocks: Downstream auth consistency tasks and schema hardening for identity management.

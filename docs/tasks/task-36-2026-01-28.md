# Task #36 â€” Lab session lifecycle table & state integrity

Date: 2026-01-28
Status:APPROVED

---

## Goal

Establish `LabSession` as the authoritative, enforceable source of truth for lab lifecycle state with explicitly defined, auditable, and fail-closed transitions so invalid or irreversible transitions cannot persist across mutation paths.

---

## Scope (Binding)

### In Scope

- Define and validate the lifecycle transition table for `LabStatus`.
- Identify all mutation paths that create or update `LabSession` state.
- Align all mutation paths to the allowed transitions.
- Enforce state integrity so invalid transitions fail closed.
- Ensure auditability for lifecycle transitions.

### Out of Scope

- UI/UX changes.
- Feature expansion beyond lifecycle integrity.
- Refactors unrelated to lifecycle enforcement or auditability.
- Schema changes unrelated to `LabSession` state integrity.

---

## Preconditions

- Docs Gatekeeper approved.
- Relevant schemas/services identified.
- Version assumptions listed below.

---

## Assumptions (Explicit)

- Prisma version 7.3.0 is authoritative for schema and migration behavior.
- PostgreSQL version 18.1 is authoritative for DB constraints/triggers/transactions.
- Next.js App Router version 15.1.0 is authoritative for mutation paths.

---

## Invariants (Must Not Be Violated)

- Real identity is preserved for any state change.
- State transitions are immutable and auditable.
- Verification remains deterministic and reproducible.
- System fails closed on invalid transitions.

---

## Step-by-Step Plan

1. Inventory all `LabSession` mutation paths (create, update, status changes) across APIs, services, jobs, and seed scripts.
2. Define the authoritative lifecycle transition table for `LabStatus`, including terminal states and guard conditions.
3. Map each mutation path to the transition table and identify gaps or invalid transitions.
4. Specify enforcement boundaries for state integrity and audit logging.
5. Summarize required alignment changes to ensure every mutation path conforms to the lifecycle table.

---

## Enforcement & Authority Decisions

- Source of truth: `LabSession` persisted state in PostgreSQL via Prisma.
- Enforcement locus (DB / Service / Dual): Dual (application guardrails + DB constraints) to ensure fail-closed integrity.
- Fail-closed behavior description: Any transition not present in the lifecycle table must be rejected and leave persisted state unchanged while emitting audit context.

---

---

## Files to NOT Touch

- forgea-monorepo/apps/forgea-admin/\*\*
- forgea-monorepo/apps/forgea-lessons/\*\*
- forgea-monorepo/apps/forgea-learn/\*\*
- forgea-monorepo/infra/\*\*

---

## Verification Criteria

- Every `LabSession` mutation path enforces only allowed transitions.
- Invalid transitions are blocked and leave persisted state unchanged.
- All valid transitions emit auditable records.
- It is impossible to persist a `LabSession` state outside the lifecycle table.

---

## Risks & Tradeoffs

- DB-level enforcement increases safety but adds migration complexity.
- Application-only enforcement risks missed mutation paths.
- Overly strict transitions may block legitimate workflows if the table is incomplete.

---

## Rollback Awareness

- Tightening constraints may require data repair for existing invalid states.
- Rolling back DB constraints may need careful migration reversal to avoid orphaned audit trails.

---

## Open Questions (If Any)

- None.

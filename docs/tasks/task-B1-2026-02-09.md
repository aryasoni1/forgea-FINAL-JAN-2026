# Task B1 â€” Database Setup

Date: 2026-02-09
Status: APPROVED

---

## Goal

Define and implement a reproducible PostgreSQL 18.1 database setup for Forgea across dev and prod, including UTC timezone enforcement, UUID strategy compliance, and provisioning/verification workflows aligned to official policies.

---

## Scope (Binding)

### In Scope

- Define and document the database provisioning approach for dev and prod (Terraform and/or Docker Compose) with exact tool versions.
- Enforce database timezone to UTC at the server level.
- Define UUID generation strategy (native `gen_random_uuid()` vs extensions) and implement required `CREATE EXTENSION` steps if needed.
- Specify how Prisma migrations are applied in dev and prod, including shadow DB expectations.
- Provide verification steps for local connectivity and environment parity.
- Address handling of local `DATABASE_URL` examples in repo to avoid unsafe assumptions.

### Out of Scope

- Schema changes unrelated to setup (tables, columns, indexes).
- Modifying existing immutability triggers or altering their logic.
- Application-layer code changes unrelated to database provisioning or configuration.

---

## Preconditions

- Docs Gatekeeper brief for B1 reviewed and incorporated.
- Official docs registry consulted for PostgreSQL, Prisma, Terraform, and Docker Compose.
- Toolchain versions sourced from `/docs/toolchain-versions.md`.
- Code Scout findings for B1 incorporated.

---

## Assumptions (Explicit)

- UUID version requirements (v4/v7 vs v1/v3/v5) will be confirmed by the user.

---

## Locked Decisions (Derived from Documentation)

- PostgreSQL server time zone MUST be set to `UTC` and `log_timezone` MUST be `UTC`. (Source: /docs/official-docs/EPIC-B/postgresql.md)
- PostgreSQL server MUST enforce SSL (`ssl = on`). (Source: /docs/official-docs/EPIC-B/postgresql.md)
- If UUID v4 or v7 is used, `uuid-ossp` MUST NOT be installed; use native `gen_random_uuid()` instead. (Source: /docs/official-docs/EPIC-B/postgres-extensions.md)
- If `pgcrypto` is used, connections MUST be SSL-encrypted. (Source: /docs/official-docs/EPIC-B/postgres-extensions.md)
- Development schema changes MUST use `prisma migrate dev` and production/staging MUST use `prisma migrate deploy`. (Source: /docs/official-docs/EPIC-B/prisma_migrations.md)
- Terraform workflows MUST use `terraform init`, then `plan -out`, then `apply` with the saved plan in CI, and commit `.terraform.lock.hcl`. (Source: /docs/official-docs/EPIC-B/db-provisioning.md)
- Docker Compose services must use `depends_on` long syntax with `condition: service_healthy` and health checks for DB readiness. (Source: /docs/official-docs/EPIC-B/docker-compose.md)

---

## Resolved Decisions (User-Provided)

- PostgreSQL version is pinned to 18.1 with allowed range `>=18.1 <19`.
- UUID extensions policy: `uuid-ossp` is allowed for legacy compatibility; new tables MUST prefer `gen_random_uuid()` (pgcrypto).
- Defaults: `timezone = UTC` and `client_encoding = UTF8`.
- Infrastructure-as-Code is owned within this repository using Terraform 1.x and Docker Compose.
- `pgcrypto` and `uuid-ossp` are allowed as trusted extensions; installation is permitted with CREATE privileges.
- Extension creation must be handled in the provisioning layer (Terraform), not via Prisma migration SQL.
- pgcrypto functions required beyond `gen_random_uuid()`: `digest`, `hmac`, `gen_random_bytes`, `crypt`, and `gen_salt` for PII hashing, masking, and local-auth hashing.

---

## Invariants (Must Not Be Violated)

- Existing immutability triggers in `packages/schema/prisma/migrations/**` remain unchanged and are accounted for in provisioning/migration steps.
- Database time semantics remain UTC-only.
- Migrations remain the single source of truth for relational schema history.
- No production workflow uses `prisma migrate dev`.

---

## Step-by-Step Plan (Non-Code)

1. Confirm the required environments (dev, prod) to provision.
2. Choose the provisioning path:
   - **Local dev**: Docker Compose-based Postgres with health checks and isolated networks.

- **Prod**: Terraform-based provisioning within this repo.

3. Define the DB configuration baseline for PostgreSQL 18.1:
   - `TimeZone = 'UTC'`
   - `log_timezone = 'UTC'`

- `client_encoding = UTF8`
- `ssl = on`
- Template DB handling for shared objects if needed.

4. Specify extension strategy:

- Existing tables MUST NOT be rewritten solely to change UUID generation.
- New tables MUST prefer `gen_random_uuid()` (`pgcrypto`).
- `uuid-ossp` remains allowed for legacy compatibility.
- Plan `CREATE EXTENSION pgcrypto;` with SSL enforcement if required.
- Only add `uuid-ossp` when legacy UUID functions are needed.

5. Define Prisma migration workflow per environment, including shadow DB requirements in dev and `migrate deploy` in prod.
6. Add verification steps: local DB connectivity, migration application, and timezone/SSL configuration validation.
7. Update documentation and registry as required by Docs Gatekeeper brief.

---

## Deliverables / Artifacts to Produce

> Final locations depend on infra ownership decision; if owned in this repo, use the paths below.

- **Dev DB provisioning (Docker Compose)**
  - forgea-monorepo/infra/docker-compose/postgres/docker-compose.yml
  - forgea-monorepo/infra/docker-compose/postgres/.env.example (non-secret defaults)
- **Prod/Shared provisioning (Terraform)**
  - forgea-monorepo/infra/terraform/postgres/ (module or root stack)
  - forgea-monorepo/infra/terraform/postgres/README.md (usage + variables)
  - .terraform.lock.hcl committed for the Terraform workspace
- **DB setup guidance**
  - docs/guides/task-B1-how-to.md (setup, migration flow, verification)
- **SQL or migration steps (if extensions required)**
  - forgea-monorepo/packages/schema/prisma/migrations/<new_migration>/migration.sql
    - Only if `uuid-ossp` or `pgcrypto` must be enabled by SQL migration rather than provisioning.

---

## Files Expected to Modify

- forgea-monorepo/infra/docker-compose/postgres/\*\* (if dev Docker Compose is in-repo)
- forgea-monorepo/infra/terraform/postgres/\*\* (if prod provisioning is in-repo)
- forgea-monorepo/packages/schema/prisma/migrations/\*\* (only if extension SQL is required)
- docs/guides/task-B1-how-to.md
- docs/master_docs.md (append Docs Gatekeeper entry if required)

---

## Files to NOT Touch

- forgea-monorepo/packages/schema/prisma/schema.prisma (unless explicitly required for UUID defaults)
- forgea-monorepo/packages/schema/prisma/migrations/20260124070452_add_immutability_triggers/migration.sql
- forgea-monorepo/packages/schema/prisma/migrations/20260124170000_add_auditlog_immutability_trigger/migration.sql
- forgea-monorepo/apps/\*\*
- forgea-monorepo/services/\*\*

---

## Verification Criteria (Machine-Checkable)

- Postgres configuration includes `TimeZone = 'UTC'` and `log_timezone = 'UTC'`.
- SSL is enforced for Postgres connections where `pgcrypto` is enabled.
- If UUID v4/v7 only: no `uuid-ossp` extension is installed.
- If UUID v1/v3/v5 required: `uuid-ossp` extension is installed in the target DB(s).
- `prisma migrate dev` is used in dev and `prisma migrate deploy` in prod.
- Dev DB health checks gate app startup in Docker Compose.
- Local DB connectivity is verified using the configured `DATABASE_URL`.

---

## Required Approvals

- Docs Gatekeeper approval (B1 brief resolved).
- Security Sentinel review if any secret handling, SSL/TLS config, or credential storage is introduced/changed.

---

## Risks & Tradeoffs

- Docs Gatekeeper indicates missing or unpinned official docs, while the registry contains pinned PostgreSQL 18.1 and extensions; this conflict must be reconciled to avoid policy drift.
- Missing provisioning scripts and timezone enforcement are currently gaps; if not addressed, environment parity and audit consistency will be compromised.
- `DATABASE_URL` values in repo `.env` files may create unsafe defaults or accidental exposure if treated as authoritative.
- Existing immutability triggers require careful ordering of migrations and provisioning steps.

---

## Open Questions (Must Be Resolved)

- None.

---

## Dependencies

- Blocked by: None.
- Unlocks: Database setup, consistent environment parity, and verification workflows for EPIC-B.

---

## Agent Assignments

- Implementer: Create provisioning artifacts and documentation per approved plan.
- QA / Verifier: Validate configuration, connectivity, and migration workflows.
- Security Sentinel: Review SSL/TLS, secrets handling, and extension usage if applicable.

---
id: A2
date: 2026-02-27
epic: EPIC-A
title: Package Manager & Workspace
status: DRAFT
source: /docs/code-scout/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A2_Package Manager & Workspace.md
knowledge-architect: /docs/knowledge-architect/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A2_Package Manager & Workspace.md
---

# Task A2 — Package Manager & Workspace

## Goal

Establish a synchronized, machine-verifiable workspace configuration across pnpm tooling, root package.json, and CI environments. This task resolves the divergence between `package.json` workspaces and `pnpm-workspace.yaml`, enforces strict version pinning with Corepack, defines explicit workspace validation commands for local development and CI, and documents the canonical source of truth for workspace configuration.

---

## Layer Classification

This task affects:

- [x] Infrastructure / External Systems
- [ ] Database Layer
- [ ] Application Service Layer
- [ ] API Layer
- [ ] Frontend/UI Layer
- [x] Documentation Only

**Justification:** This task spans package manager configuration (infrastructure) and developer documentation. These concerns are atomic and cannot be split—workspace configuration must be synchronized across all tooling simultaneously.

---

## Cross-Epic Impact

**No cross-epic impact.**

Feature A2 builds directly on Feature A1 (Repository & Structure) and is a prerequisite for all future EPICS. No other EPICS depend on A2-specific decisions at this stage.

---

## Migration Risk Level

**LOW — additive with minor config sync**

All changes are additive configuration updates and new documentation. The only modification is adding `services/*` to `pnpm-workspace.yaml` to match existing `package.json` configuration—this is a non-breaking alignment that makes the workspace more consistent.

---

## Scope (Binding)

### In Scope

1. **Workspace Synchronization:**
   - Add `services/*` to `pnpm-workspace.yaml` packages array to match `package.json` workspaces
   - Validate that `package.json` includes exact version pin: `"packageManager": "pnpm@10.28.1"`
   - Document canonical source of truth for workspace declarations

2. **Version Pinning & Corepack Setup:**
   - Ensure `packageManager` field in root `package.json` is set to `pnpm@10.28.1` [KNOWLEDGE-ARCHITECT APPROVED]
   - Document Node.js and pnpm version compatibility pairs (Node 18.12+ with pnpm 10.x)
   - Document Corepack setup: `corepack enable pnpm`
   - Update `/docs/toolchain-versions.md` with approved version guidance

3. **Developer Verification Checklist:**
   - Document minimal CLI commands for developers to verify workspace setup locally:
     - `pnpm ls -r --depth -1` (verify package discovery)
     - `turbo ls` (verify Turborepo discovery)
     - `pnpm install` (validate workspace resolution)
   - Create `/docs/official-docs/workspace-setup-checklist.md` with step-by-step verification
   - Document expected outputs and troubleshooting steps

4. **CI Validation & Enforcement:**
   - Define exact CI steps: checkout → cache setup → pnpm install → Turbo execution
   - Document required pnpm CI flags: `--frozen-lockfile` (automatic in CI)
   - Document Corepack enforcement in CI environments
   - Document cache strategies for pnpm and Turborepo in CI

5. **Workspace Resolution Guard Rails:**
   - Document strict settings for pnpm:
     - `packageManagerStrictVersion: true` (fail if version drifts)
     - `disallowWorkspaceCycles: true` (prevent dependency cycles)
     - `strictPeerDependencies: true` (catch peer dependency mismatches)
   - Document `turbo.json` settings to guarantee workspace consistency
   - Document the role of `pnpm-lock.yaml` in hashing and caching

6. **Official Documentation:**
   - Create `/docs/official-docs/pnpm-configuration.md` with minimal configuration requirements
   - Create `/docs/official-docs/workspace-validation-process.md` with CI validation steps
   - Create `/docs/official-docs/corepack-and-version-management.md` with setup instructions
   - Update `/docs/official-docs/repo-boundaries.md` (from A1) with workspace-level boundaries

### Out of Scope

- Modification of individual package source code
- Changes to database migrations (LOCKED)
- Implementation of remote caching for Turborepo (future task)
- Implementation of pre-commit hooks (future task)
- Creation of the planned "workspace-config verifier" agent (future infrastructure task)

---

## Documentation & Truth Intake

### Verified Implementation Truth (Primary)

- [x] `/docs/knowledge-architect/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A2_Package Manager & Workspace.md`
- [x] `/docs/technology/docs-tech-notebooklm/divison_ques/07-devops-ci-cd-infra-tooling.md`

### Toolchain Status

- [x] `/docs/toolchain-versions.md`

**Note:** All version pins in this task are verified against Knowledge-Architect answers. Specific approvals documented below.

### Missing Truths / Knowledge Gaps

**NONE.** All required questions for Feature A2 have been answered in the Knowledge-Architect study guide:

- ✅ pnpm version compatibility with Node.js (18.12+, 20, 22, 24)
- ✅ Canonical workspace file specification (pnpm-workspace.yaml is authoritative)
- ✅ Minimal CLI validation commands for workspace discovery
- ✅ pnpm-workspace.yaml minimal schema for services/\* inclusion
- ✅ Corepack setup and packageManager field enforcement
- ✅ CI steps and caching strategies (pnpm + Turborepo)
- ✅ Workspace resolution guards (cycles, peer deps, version strict)
- ✅ Machine-checkable invariants for HARD-LOCK enforcement

---

## Code Scout Correlation (Facts Only)

### What Exists

- Root `package.json` at `/forgea-monorepo/package.json` with:
  - `packageManager: "pnpm@10.28.1"` (version-pinned, correct)
  - `workspaces: ["apps/*", "packages/*", "services/*"]` (includes services)
  - Scripts: `build`, `dev`, `lint` (all aliasing to turbo commands)

- `/forgea-monorepo/pnpm-workspace.yaml` with:
  - `packages: ["apps/*", "packages/*"]` (services missing)

- 13 actual packages: 4 apps, 6 packages, 3 services

### What is Missing

- `services/*` entry in `pnpm-workspace.yaml` (divergence from package.json)
- Official documentation explaining workspace configuration
- Developer verification checklist for workspace setup
- CI validation steps documentation
- Corepack setup documentation

### What Must Change

- Add `- "services/*"` to `pnpm-workspace.yaml` packages array
- Document canonical source of truth (pnpm-workspace.yaml is authoritative for pnpm)
- Create developer setup and verification documentation
- Create CI validation documentation
- Ensure Corepack configuration is documented and enforced

---

## Preconditions

### Dependencies (Internal/External)

- **Feature A1** must be completed (repository structure and import boundaries established)
- **pnpm v10.28.1** must be pinned in `packageManager` field [VERIFIED in Knowledge-Architect]
- **Node.js v20.x or compatible** (v18.12+, v22, v24) must be available [VERIFIED in Knowledge-Architect]
- **Corepack** must be available (ships with Node.js v16.10+) [VERIFIED in Knowledge-Architect]
- **Turborepo v2.x** must be installed [VERIFIED]

### Required Previous Tasks

- **Task A1** must be completed (repository structure, boundary enforcement, governance files)

### Required Environment State

- Clean working directory with no uncommitted changes to workspace config
- All 13 workspace packages must have valid `package.json` files with `name` fields
- No circular workspace dependencies

---

## Locked Decisions (Derived from Manual Build Truth)

### Decision 1: pnpm-workspace.yaml is Canonical Source for Workspace Configuration

**Source:** [KNOWLEDGE-ARCHITECT A2 → Beginner Answer #2]

> "In pnpm workspaces, the pnpm-workspace.yaml file is the canonical location for defining workspace package globs. A pnpm workspace must have this file in its root, and it uses the packages field to include or exclude directories."

**Implementation:** Add `services/*` to `pnpm-workspace.yaml`. Document that this file is authoritative and the `package.json` workspaces field is informational only (for other package managers that may use this repo in the future).

**Rejection Note:** The draft `toolchain-versions.md` did not clarify this canonical source. The Knowledge-Architect answer provides explicit documentation authority.

---

### Decision 2: pnpm@10.28.1 with Node.js v18.12+ Compatibility

**Source:** [KNOWLEDGE-ARCHITECT A2 → Beginner Answer #1]

> "To run pnpm@10.28.1, you must use one of the following supported Node.js versions: Node.js 18 (v18.12 or higher), Node.js 20, Node.js 22, Node.js 24. Node.js 14 and 16 are not supported by pnpm v10."

**Implementation:** Document that pnpm@10.28.1 requires Node.js >=18.12.0. Current pin in toolchain-versions.md specifies Node 20.x, which is compatible.

**Version Pin:** pnpm@10.28.1 [ALREADY PINNED in package.json, APPROVED via Knowledge-Architect]

---

### Decision 3: Corepack Enable as Setup Command

**Source:** [KNOWLEDGE-ARCHITECT A2 → Beginner Answer #1]

> "Running `corepack enable pnpm` tells your system to automatically download and run the exact pnpm version specified in the packageManager field of your package.json."

**Implementation:** Document `corepack enable pnpm` as the required developer setup command. This automatically uses the pinned version specified in the `packageManager` field.

---

### Decision 4: Frozen-Lockfile is Automatic in CI

**Source:** [KNOWLEDGE-ARCHITECT A2 → Beginner Answer #1]

> "pnpm install --frozen-lockfile replicates the standard CI behavior by strictly installing dependencies from pnpm-lock.yaml. This command will intentionally fail if the lockfile is missing or out of sync with the manifest."

**Implementation:** Document that CI automatically defaults to frozen-lockfile behavior. Developers can run `pnpm install --frozen-lockfile` locally to replicate CI exactly.

---

### Decision 5: Workspace Validation Commands

**Source:** [KNOWLEDGE-ARCHITECT A2 → Beginner Answer #3]

> "Command: `turbo ls` — Expected Output: A list of all packages successfully discovered in your repository alongside their file paths. Command: `pnpm ls --depth -1 -r` — Expected Output: A list displaying only the projects that pnpm recognizes in the workspace."

**Implementation:** Document both commands as part of developer verification checklist. These are the authoritative methods to verify workspace discovery without running full installs.

---

### Decision 6: Strict pnpm Settings for Guardrails

**Source:** [KNOWLEDGE-ARCHITECT A2 → Senior Answer #1]

> "Enforce `packageManagerStrictVersion: true` to force CI to fail if the pnpm version doesn't match. Enable `disallowWorkspaceCycles: true` and `strictPeerDependencies: true`."

**Implementation:** Document these settings as required for CI enforcement. These are invariants that must be verified before marking HARD-LOCK as active.

---

### Decision 7: pnpm-lock.yaml is Required for Turborepo Stability

**Source:** [KNOWLEDGE-ARCHITECT A2 → Intermediate Answer #7]

> "Commit the Lockfile: Ensure pnpm-lock.yaml is committed. Turborepo uses the lockfile to understand the dependencies between internal packages within your workspace."

**Implementation:** Document that `pnpm-lock.yaml` must always be committed to version control. This is a foundational invariant for reproducible builds.

---

## Invariants (Must Not Be Violated)

1. **Workspace Synchronization Invariant:** `pnpm-workspace.yaml` packages array MUST include all workspace directories: `apps/*`, `packages/*`, `services/*`. Any divergence from `package.json` workspaces causes inconsistent package discovery.

2. **Version Pinning Invariant:** The `packageManager` field in root `package.json` MUST be exactly `pnpm@10.28.1`. Any drift breaks Corepack and Turborepo stability.

3. **Lockfile Commitment Invariant:** `pnpm-lock.yaml` MUST be committed to version control and never modified manually. This is the source of truth for deterministic installs.

4. **Node Compatibility Invariant:** The active Node.js version MUST be >=18.12.0 and <25.0.0 (currently pinned to 20.x). pnpm 10.x does not support Node 16 or earlier.

5. **No Circular Dependencies Invariant:** The workspace MUST NOT contain circular dependency loops. pnpm will fail resolution if cycles are detected.

6. **Immutability Trigger Preservation:** All existing database migrations under `packages/schema/prisma/migrations/` MUST remain untouched (HARD LOCK).

7. **Corepack Setup Invariant:** Developers MUST run `corepack enable pnpm` before first use. This enables automatic version management via the `packageManager` field.

---

## Step-by-Step Plan (Non-Code)

### Step 1: Verify Current State

**Source:** [KA: Beginner #3]

1.1. Open `/forgea-monorepo/pnpm-workspace.yaml`
1.2. Verify that `apps/*` and `packages/*` are present
1.3. Confirm that `services/*` is NOT currently present
1.4. Open `/forgea-monorepo/package.json`
1.5. Confirm `packageManager: "pnpm@10.28.1"` is set
1.6. Confirm `workspaces: ["apps/*", "packages/*", "services/*"]` includes services

### Step 2: Update pnpm-workspace.yaml

**Source:** [KA: Beginner #4]

2.1. Add `- "services/*"` to the `packages:` array in `pnpm-workspace.yaml`
2.2. Verify the updated YAML syntax is valid
2.3. Resulting packages array should be: `- "apps/*"`, `- "packages/*"`, `- "services/*"`

### Step 3: Validate Workspace Consistency

**Source:** [KA: Beginner #3]

3.1. Run `pnpm ls --depth -1 -r` to verify pnpm discovers all packages
3.2. Run `turbo ls` to verify Turborepo discovers all packages
3.3. Run `pnpm install` to validate workspace resolution (no errors expected)
3.4. Verify that all 13 packages (4 apps + 6 packages + 3 services) are listed

### Step 4: Document Canonical Source of Truth

**Source:** [KA: Beginner #2]

4.1. Create `/docs/official-docs/workspace-configuration-canonical.md`
4.2. Document that `pnpm-workspace.yaml` is authoritative for pnpm workspace structure
4.3. Document that `package.json` workspaces is informational (for other package managers)
4.4. Document the required packages array entries and their glob patterns

### Step 5: Document Version Compatibility

**Source:** [KA: Beginner #1]

5.1. Create `/docs/official-docs/pnpm-node-compatibility.md`
5.2. Document that pnpm@10.28.1 requires Node >=18.12.0
5.3. Document compatible Node versions: v18.12+, v20, v22, v24
5.4. Document that Node v14 and v16 are NOT supported
5.5. Document current toolchain pin: Node v20.x (compatible)

### Step 6: Document Corepack Setup

**Source:** [KA: Beginner #1]

6.1. Create `/docs/official-docs/corepack-setup-guide.md`
6.2. Document the command: `corepack enable pnpm`
6.3. Document why: automatically uses exact version in `packageManager` field
6.4. Document alternative: `corepack use pnpm@10.28.1`
6.5. Document that Corepack ships with Node.js v16.10+

### Step 7: Create Developer Verification Checklist

**Source:** [KA: Beginner #3]

7.1. Create `/docs/official-docs/workspace-setup-checklist.md`
7.2. Document command: `pnpm ls --depth -1 -r` with expected output (list of 13 packages)
7.3. Document command: `turbo ls` with expected output (same 13 packages with paths)
7.4. Document command: `pnpm install` with expected result (successful completion)
7.5. Document troubleshooting steps for each command

### Step 8: Document CI Validation Steps

**Source:** [KA: Intermediate #7]

8.1. Create `/docs/official-docs/ci-workspace-validation.md`
8.2. Document GitHub Actions setup: actions/checkout@v4 with fetch-depth: 2
8.3. Document pnpm cache setup using actions/setup-node@v4 with cache: 'pnpm'
8.4. Document that pnpm install automatically runs with --frozen-lockfile in CI
8.5. Document Turborepo cache setup: cache path `.turbo` with key `${{ runner.os }}-turbo-${{ github.sha }}`
8.6. Document command: `turbo run build --affected` for selective execution

### Step 9: Document Strict pnpm Settings for CI

**Source:** [KA: Senior #1]

9.1. Create `/docs/official-docs/pnpm-strict-settings.md`
9.2. Document setting: `packageManagerStrictVersion: true` (fail if version drifts)
9.3. Document setting: `disallowWorkspaceCycles: true` (prevent circular dependencies)
9.4. Document setting: `strictPeerDependencies: true` (catch peer dependency mismatches)
9.5. Document where these settings are configured (pnpm configuration)
9.6. Document the CI enforcement: all three settings must be enabled

### Step 10: Document Lockfile Importance

**Source:** [KA: Intermediate #7]

10.1. Create `/docs/official-docs/pnpm-lockfile-strategy.md`
10.2. Document that `pnpm-lock.yaml` must be committed to version control
10.3. Document that this file is the source of truth for deterministic installs
10.4. Document that Turborepo uses the lockfile for hashing and caching
10.5. Document that manual edits to the lockfile are forbidden

### Step 11: Update Toolchain Versions

**Source:** [KA: Beginner #5]

11.1. Open `/docs/toolchain-versions.md`
11.2. Add or update pnpm section with explicit guidance on: - Version pin: 10.28.1 - Why: workspace semantics, deterministic installs, CI frozen-lockfile - Enforcement: Corepack, packageManager field - Compatibility: Node >=18.12, <25

### Step 12: Verify Lockfile Existence

**Source:** [KA: Intermediate #7]

12.1. Confirm `/forgea-monorepo/pnpm-lock.yaml` exists
12.2. Verify the lockfile is committed to version control
12.3. Document the role of the lockfile in CI/CD

---

## Deliverables

1. **Updated `pnpm-workspace.yaml`** with `services/*` included
2. **`/docs/official-docs/workspace-configuration-canonical.md`** explaining canonical source
3. **`/docs/official-docs/pnpm-node-compatibility.md`** documenting version pairs
4. **`/docs/official-docs/corepack-setup-guide.md`** with setup instructions
5. **`/docs/official-docs/workspace-setup-checklist.md`** with developer verification commands
6. **`/docs/official-docs/ci-workspace-validation.md`** documenting CI steps
7. **`/docs/official-docs/pnpm-strict-settings.md`** documenting guardrails
8. **`/docs/official-docs/pnpm-lockfile-strategy.md`** explaining lockfile role
9. **Updated `/docs/toolchain-versions.md`** with pnpm guidance
10. **This task document** at `/docs/tasks/EPIC-A/task-A2-2026-02-27.md`

---

## Files Expected to Modify

- `/forgea-monorepo/pnpm-workspace.yaml` (add `- "services/*"`)
- `/docs/toolchain-versions.md` (enhance pnpm guidance)

---

## Files to Create

- `/docs/official-docs/workspace-configuration-canonical.md`
- `/docs/official-docs/pnpm-node-compatibility.md`
- `/docs/official-docs/corepack-setup-guide.md`
- `/docs/official-docs/workspace-setup-checklist.md`
- `/docs/official-docs/ci-workspace-validation.md`
- `/docs/official-docs/pnpm-strict-settings.md`
- `/docs/official-docs/pnpm-lockfile-strategy.md`

---

## Files to NOT Touch

- `/forgea-monorepo/package.json` (packageManager already correct, do not modify)
- `/forgea-monorepo/pnpm-lock.yaml` (commit only, never manually edit)
- `/forgea-monorepo/packages/schema/prisma/migrations/**/*` (HARD LOCK — immutability triggers)
- `/forgea-monorepo/turbo.json` (out of scope; separate task)
- Any source code files (out of scope; configuration only)

---

## Verification Criteria (Machine-Checkable)

1. **Workspace Configuration Sync:**
   - ✅ `grep -q '"services/\*"' pnpm-workspace.yaml` exits with code 0 (services/\* present)
   - ✅ `pnpm ls --depth -1 -r` lists exactly 13 packages (4 apps + 6 packages + 3 services)
   - ✅ `turbo ls` lists same 13 packages as pnpm

2. **Package Manager Field:**
   - ✅ `grep -q '"packageManager": "pnpm@10.28.1"' package.json` exits with code 0
   - ✅ Version matches Knowledge-Architect approved version

3. **Lockfile Presence:**
   - ✅ `test -f pnpm-lock.yaml` exits with code 0
   - ✅ File is committed to version control (not in .gitignore)

4. **Workspace Resolution:**
   - ✅ `pnpm install` completes successfully without errors
   - ✅ No workspace resolution errors in output
   - ✅ No circular dependency warnings

5. **Documentation Completeness:**
   - ✅ `test -f docs/official-docs/workspace-configuration-canonical.md` exits with code 0
   - ✅ `test -f docs/official-docs/pnpm-node-compatibility.md` exits with code 0
   - ✅ `test -f docs/official-docs/corepack-setup-guide.md` exits with code 0
   - ✅ `test -f docs/official-docs/workspace-setup-checklist.md` exits with code 0
   - ✅ `test -f docs/official-docs/ci-workspace-validation.md` exits with code 0
   - ✅ `test -f docs/official-docs/pnpm-strict-settings.md` exits with code 0
   - ✅ `test -f docs/official-docs/pnpm-lockfile-strategy.md` exits with code 0

6. **Toolchain Documentation:**
   - ✅ `/docs/toolchain-versions.md` contains pnpm guidance
   - ✅ Documentation references pnpm@10.28.1 as approved version
   - ✅ Node.js compatibility (>=18.12.0) is documented

---

## Risks & Tradeoffs

### Risk 1: Lockfile Regeneration

**Likelihood:** High (expected)
**Impact:** Low
**Mitigation:** Adding `services/*` to workspace will regenerate `pnpm-lock.yaml`. This is expected and correct. Commit the updated lockfile.

### Risk 2: CI Pipeline Compatibility

**Likelihood:** Low
**Impact:** Medium
**Mitigation:** If CI steps fail after this task, verify that cached artifacts from the old workspace configuration are invalidated. The cache keys documented in CI validation guide should account for this.

### Risk 3: Developer Environment Drift

**Likelihood:** Medium
**Impact:** Low
**Mitigation:** Document Corepack setup clearly and require it in onboarding. Enforce via CI check: `pnpm -v` should match packageManager field.

### Tradeoff: Manual vs. Automated Workspace Verification

**Decision:** Document explicit CLI commands for manual verification rather than implementing a custom verifier agent.
**Rationale:** The Knowledge-Architect answer specifies that `pnpm install`, `pnpm ls -r`, and `turbo ls` are the authoritative verification methods. The planned "workspace-config verifier" agent is a future enhancement, not a blocking requirement for A2.

---

## Dependencies

### Blocked By

- **Task A1** (Repository & Structure must be complete)

### Unlocks

- **Task A3:** CI/CD pipeline configuration (depends on workspace validation steps)
- **Task A4:** Pre-commit hooks (depends on workspace verification commands)
- **All EPIC-B through EPIC-O tasks:** All future work depends on stable workspace configuration

---

## Agent Assignments

- **Implementer:** Execute Steps 1-12 verbatim; create all deliverables
- **QA:** Verify all machine-checkable criteria pass
- **Documenter:** (Not required; implementation includes all documentation)

---

## Approval Required

Planner has produced the authoritative task plan.

Please respond with:

- ✅ **Planner approved** — Proceed to implementation
- ✏️ **Requested changes** — Specify modifications required

---

**END OF TASK DOCUMENT**

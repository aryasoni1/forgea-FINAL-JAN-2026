# Task A8 — Environment & Safety

Date: 2026-02-06
Status: APPROVED

---

## Goal

Ensure every Forgea workspace dependency and runtime has a documented, measurable environment setup: canonical `.env.example`, a manifest of required and optional variables, alignment with Next.js (App Router) and dotEnv semantics, and a placeholder validation surface so missing secrets fail-closed before production deployment.

## Scope (Binding)

- Provide a single canonical `/forgea-monorepo/.env.example` at the monorepo root listing every shared env var, avoiding per-package examples, and explicitly labeling `DATABASE_URL` as required while `FORGEA_AUDIT_SINK_URL` and `FORGEA_SECURITY_ALERT_SINK_URL` remain optional.
- Document the env-variable manifesto in the official docs (extend `/docs/official-docs/nextjs-environment-variables.md` and `/docs/official-docs/dotenv.md` per Docs Gatekeeper guidance) so the list references Next.js 15.1.0 and dotenv semantics.
- Introduce a centralized, no-op-ready validation surface (placeholder logic) that other packages can call before runtime so we stop relying solely on ad-hoc guards like the one already in `packages/schema/src/db.ts`.
- Capture the latest Docs Gatekeeper findings in the task doc and note the outstanding approvals/updates required for this feature.

### Out of Scope

- Implementing secret provisioning or runtime fetching from external vaults.
- Any changes that expose sensitive variables to the browser (Next.js `NEXT_PUBLIC_*` semantics are documented but not altered).
- Rewriting or deleting existing `.env.*` entries; the plan only adds documentation and safe defaults.

## Preconditions

- Code Scout report for A8 has been reviewed (`/docs/code-scout/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A8_Environment & Safety.md`).
- Docs Gatekeeper brief for A8 exists (`/docs/docs-gatekeeper/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A8_Environment & Safety.md`) and highlights required official docs.
- Toolchain versions are governed by `/docs/toolchain-versions.md`; no env-related tool is marked BLOCKED.
- Root `.gitignore` already ignores `.env` and `.env.local`; that protection is preserved.

## Assumptions (Explicit)

- The runtime guards already present (e.g., `packages/schema/src/db.ts` throwing when `DATABASE_URL` is missing) remain and can be referenced when building the placeholder validation surface.
- There is no existing `.env.example`, so the new file must be authored from first principles using the discovered env vars.
- Environment docs will live under `/docs/official-docs/EPIC-A/` so they can be referenced by future planners.

## Locked Decisions (Derived from Documentation)

- Next.js App Router environment variable rules must align with the official Next.js 15.1.0 documentation, including file naming (`.env`, `.env.local`, `.env.production`) and `NEXT_PUBLIC_` exposure semantics (source: Docs Gatekeeper brief for A8 referencing Next.js environment docs).
- Dotenv usage for local or non-Next runtimes must follow the pinned 16.x branch (source: same Docs Gatekeeper brief and `/docs/toolchain-versions.md`).
- Repository-level `.gitignore` must keep `.env` entries ignored (source: `/docs/official-docs/EPIC-A/git-and-gitignore.md` as noted by the code scout report).

## Resolved Decisions (User-Provided)

- Environment files should never be checked into Git; the existing `.gitignore` already enforces this for `.env` and `.env.local`.
- Runtime failures must be prefered over silent degradation when required vars like `DATABASE_URL` are missing (per `packages/schema/src/db.ts`).

## Invariants (Must Not Be Violated)

- The system fails closed on missing required env vars.
- No secrets or `.env` files are committed to GitHub.
- Documentation and examples do not expose production secrets; placeholders or readable format only.

## Step-by-Step Plan (Non-Code)

1. Confirm the monorepo-wide env inventory, deciding that only `DATABASE_URL` is required (fail-closed) while the audit and security sink URLs stay optional, and ensure a single root `.env.example` captures these states.
2. Draft `/forgea-monorepo/.env.example` with placeholders for the required and optional vars, including inline guidance that only `DATABASE_URL` must trigger a fail-closed error today.
3. Extend `/docs/official-docs/nextjs-environment-variables.md` with the canonical manifest, linking each entry to the Next.js 15.1.0 semantics and clarifying which vars live server-only versus those safe for the client.
4. Extend `/docs/official-docs/dotenv.md` with pinned version information, loading order, and guidance for when to rely on dotenv versus host-provided envs; include references to the newly created `.env.example` for developer onboarding.
5. Define a placeholder validation surface (e.g., `packages/config/env.ts` exporting `validateEnv()`) that throws when `DATABASE_URL` is missing, and have `packages/schema/src/db.ts` call it to prove the pattern without full schema enforcement.
6. Update this task doc and the Docs Gatekeeper brief with the new deliverables and note that approval is pending until the official docs and validations are in place.

## Files Expected to Modify

- forgea-monorepo/.env.example (new canonical file)
- docs/official-docs/nextjs-environment-variables.md (extend with manifest + Next.js semantics)
- docs/official-docs/dotenv.md (pin version + loading guidance)
- docs/docs-gatekeeper/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A8_Environment & Safety.md (record updated status once docs are extended)
- Forgea package(s) chosen for the validation placeholder (candidate: packages/config or a new shared package/ folder)

## Files to NOT Touch

- `.env` files or other secrets in repo history (none should exist).
- CI secrets pipelines or runtime deployment manifests that are unrelated to env onboarding.
- Next.js app code unless it directly consumes documented env vars; no refactors of application logic.

## Verification Criteria (Machine-Checkable)

- A root `.env.example` exists and lists every env variable referenced in the repo, with required vs optional annotations.
- `/docs/official-docs/nextjs-environment-variables.md` and `/docs/official-docs/dotenv.md` include the new manifest and version pinning; updates are noted in the Docs Gatekeeper brief.
- A validation surface exists (even if no checks yet) and is referenced by at least one package to demonstrate integration.
- Docs Gatekeeper entry for A8 is updated to record that the documentation gap is filled and approval is granted.

## Risks & Tradeoffs

- Over-documenting optional vars may make the manifest hard to maintain; prefer a short list of vetted, shared entries.
- Placeholder validation logic may be ignored if not wired into a CI check; the plan should include follow-up steps for future implementers to strengthen it.
- Relying on `.env.example` alone may still leave onboarding gaps; cross-linking to docs and gatekeeper output reduces that risk.

## Open Questions

- (Resolved) `.env.example` must live at `/forgea-monorepo/.env.example`; no per-package copies are allowed.
- (Resolved) Only `DATABASE_URL` is required for A8; the sink URLs remain optional but documented until a future enforcement phase.

## Dependencies

- Blocked by: Docs Gatekeeper confirmation that the Next.js and dotenv official docs are recorded and linked; the manifest must match those references.
- Unlocks: Clear developer onboarding for env vars, consistent validations, and safe secrets handling for future features.

## Docs Gatekeeper Output

- docs/docs-gatekeeper/EPIC-A — MONOREPO & DEVELOPER TOOLING FOUNDATION/A8_Environment & Safety.md (Updated: documentation completed and approval granted).

## Docs Gatekeeper Update (2026-02-06)

- Next.js environment policy updated and pinned to v15.1.0.
- dotenv policy updated and pinned to v16.4.x.
- Canonical env manifest documented and linked to `/forgea-monorepo/.env.example`.
- Docs Gatekeeper approval recorded in the A8 brief.
